<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buckshot Roulette - æˆ¿é—´</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <style>
      /* æ·»åŠ åœ¨<style>æ ‡ç­¾å†… */
      #target-selection-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }
      #target-selection-overlay:not(.hidden) {
        display: flex; /* å½“æ²¡æœ‰hiddenç±»æ—¶æ˜¾ç¤º */
        justify-content: center;
        align-items: center;
      }
      .selection-box {
        background-color: #1e1e1e;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        min-width: 300px;
      }

      #target-buttons {
        margin: 15px 0;
      }

      #target-buttons button {
        margin: 5px;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        max-width: 800px;
        width: 100%;
      }

      h1,
      h2 {
        text-align: center;
        color: #ff5252;
      }

      .btn {
        background-color: #ff5252;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      .btn:hover {
        background-color: #ff0000;
      }

      .btn-secondary {
        background-color: #444;
      }

      .btn-secondary:hover {
        background-color: #666;
      }

      #message-box {
        background-color: #1e1e1e;
        border: 1px solid #444;
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
        height: 150px;
        overflow-y: auto;
      }

      .message {
        margin-bottom: 8px;
      }

      .player-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin: 20px 0;
      }

      .player-card {
        background-color: #1e1e1e;
        border: 1px solid #444;
        border-radius: 5px;
        text-align: center;
      }
      .player-card {
        margin: 10px;
        padding: 8px;
        width: 120px; /* ç¼©å°å¡ç‰‡å°ºå¯¸ */
      }

      .player-emoji {
        font-size: 24px; /* ç¼©å°è¡¨æƒ…ç¬¦å· */
        margin: 5px 0;
      }

      .player-health {
        display: flex;
        justify-content: center;
      }

      .health-point {
        width: 15px;
        height: 15px;
        background-color: #ff5252;
        border-radius: 50%;
        margin: 0 3px;
      }

      .health-point.empty {
        background-color: #444;
      }

      .game-board {
        display: none;
        position: relative;
        width: 100%;
        height: 500px;
        padding: 20px;
        background-color: #1e1e1e;
        border-radius: 10px;
        margin: 20px 0;
        overflow: hidden;
      }
      @media (max-width: 768px) {
        .player-position {
          width: 100px;
        }
        .gun {
          font-size: 36px;
        }
      }
      .gun-container {
        position: absolute;
        top: 50%; /* ä¸‹ç§»æªæ”¯ä½ç½® */
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }

      .gun {
        font-size: 48px; /* ç¼©å°æªæ”¯å›¾æ ‡ */
        cursor: pointer;
        position: relative; /* æ·»åŠ å±‚çº§æ§åˆ¶ */
        z-index: 1; /* ç¡®ä¿æªæ”¯åœ¨ç©å®¶ä¸Šæ–¹ */
      }

      .bullets-info {
        font-size: 14px;
        margin-top: 10px;
      }

      .player-position {
        position: absolute;
        width: 120px; /* ç¼©å°å®¹å™¨å®½åº¦ */
        text-align: center;
        z-index: 0; /* ç¡®ä¿ç©å®¶åœ¨æªæ”¯ä¸‹æ–¹ */
      }

      .player-position.top {
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
      }

      .player-position.right {
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
      }

      .player-position.bottom {
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
      }

      .player-position.left {
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
      }
      .player-position.top {
        z-index: 2;
      }

      .player-position.left,
      .player-position.right {
        z-index: 1;
      }
      .items-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }

      .item {
        background-color: #333;
        border: 1px solid #444;
        border-radius: 5px;
        padding: 5px 10px;
        margin: 0 5px;
        cursor: pointer;
      }

      .item:hover {
        background-color: #444;
      }

      .current-player {
        border: 2px solid #ff5252;
      }

      .dealer {
        background-color: #2c3e50;
      }

      .hidden {
        display: none;
      }

      #game-log {
        background-color: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin-top: 20px;
        max-height: 150px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Buckshot Roulette</h1>

      <!-- æˆ¿é—´é¡µé¢ -->
      <div id="room-screen">
        <h2>æˆ¿é—´: <span id="room-id-display"></span></h2>
        <div id="room-controls" style="text-align: center">
          <button class="btn" id="start-game-btn">å¼€å§‹æ¸¸æˆ</button>
          <button class="btn btn-secondary" id="leave-room-btn">
            ç¦»å¼€æˆ¿é—´
          </button>
        </div>

        <h3>ç©å®¶åˆ—è¡¨</h3>
        <div class="player-list" id="player-list">
          <!-- ç©å®¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div id="message-box">
          <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>
      <!-- æ·»åŠ åœ¨game-screenåŒçº§ä½ç½® -->
      <div id="target-selection-overlay" class="hidden">
        <div class="selection-box">
          <p>é€‰æ‹©å°„å‡»ç›®æ ‡ï¼š</p>
          <div id="target-buttons"></div>
          <button class="btn btn-secondary" id="cancel-selection">å–æ¶ˆ</button>
        </div>
      </div>

      <!-- æ¸¸æˆé¡µé¢ -->
      <div id="game-screen" class="hidden">
        <div class="game-board" id="game-board">
          <div class="player-position top" id="position-top">
            <!-- ä¸Šæ–¹ç©å®¶ -->
          </div>
          <div class="player-position right" id="position-right">
            <!-- å³æ–¹ç©å®¶ -->
          </div>
          <div class="player-position bottom" id="position-bottom">
            <!-- ä¸‹æ–¹ç©å®¶ -->
          </div>
          <div class="player-position left" id="position-left">
            <!-- å·¦æ–¹ç©å®¶ -->
          </div>

          <div class="gun-container">
            <div class="gun" id="gun">ğŸ”«</div>
            <div class="bullets-info" id="bullets-info">å‰©ä½™å­å¼¹: 0</div>
          </div>
        </div>

        <div id="game-log">
          <!-- æ¸¸æˆæ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button class="btn btn-secondary" id="back-to-room-btn">
            è¿”å›æˆ¿é—´
          </button>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let socket = io();
      let currentRoom = null;
      let currentPlayerId = null;
      let isMyTurn = false;
      let gameState = null;

      // è·å–æˆ¿é—´IDå’Œç©å®¶åå­—
      const roomId = window.location.pathname.split("/").pop();
      const urlParams = new URLSearchParams(window.location.search);
      const playerName =
        urlParams.get("name") || "æ¸¸å®¢" + Math.floor(Math.random() * 1000);

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        // è®¾ç½®Socket.IOå¤„ç†ç¨‹åº
        socket = setupSocketHandlers(socket);

        // æ˜¾ç¤ºæˆ¿é—´ID
        document.getElementById("room-id-display").textContent = roomId;

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        document
          .getElementById("leave-room-btn")
          .addEventListener("click", leaveRoom);
        document
          .getElementById("start-game-btn")
          .addEventListener("click", startGameRequest);
        document
          .getElementById("back-to-room-btn")
          .addEventListener("click", backToRoom);
        document.getElementById("gun").addEventListener("click", useGun);

        // è‡ªåŠ¨åŠ å…¥æˆ¿é—´
        joinRoom();
      });

      // å•ä¸€çš„Socket.IOå¤„ç†å‡½æ•°
      function setupSocketHandlers(socket) {
        socket.on("connect", () => {
          console.log("Connected to server");
          addMessage("å·²è¿æ¥åˆ°æœåŠ¡å™¨");
        });

        socket.on("disconnect", () => {
          console.log("Disconnected from server");
          addMessage("ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥");
          window.location.href = "/";
        });

        socket.on("error", (data) => {
          console.error("Error:", data.message);
          addMessage("é”™è¯¯: " + data.message);
        });

        socket.on("joined_room", (data) => {
          console.log("Joined room:", data);
          joinedRoom(data);
        });

        socket.on("player_joined", (player) => {
          console.log("Player joined:", player);
          addMessage(`${player.name} åŠ å…¥äº†æˆ¿é—´`);
          updatePlayersList(player, "add");
        });

        socket.on("player_left", (player) => {
          console.log("Player left:", player);
          addMessage(`${player.name} ç¦»å¼€äº†æˆ¿é—´`);
          updatePlayersList(player, "remove");
        });

        socket.on("room_updated", (room) => {
          console.log("Room updated:", room);
          updateRoom(room);
        });

        socket.on("game_started", (gameState) => {
          console.log("Game started:", gameState);
          startGame(gameState);
        });

        socket.on("game_updated", (data) => {
          console.log("Game updated:", data);
          updateGame(data);
        });

        socket.on("game_ended", (data) => {
          console.log("Game ended:", data);
          endGame(data);
        });

        socket.on("left_room", (data) => {
          console.log("Left room:", data);
          window.location.href = "/";
        });

        return socket;
      }

      // è¾…åŠ©å‡½æ•°
      function showScreen(screenId) {
        // éšè—æ‰€æœ‰å±å¹•
        document.getElementById("room-screen").classList.add("hidden");
        document.getElementById("game-screen").classList.add("hidden");

        // æ˜¾ç¤ºæŒ‡å®šçš„å±å¹•
        document.getElementById(screenId).classList.remove("hidden");

        if (screenId === "game-screen") {
          document.getElementById("game-board").style.display = "block";
        }
      }

      function addMessage(message) {
        const messageBox = document.getElementById("message-box");
        const messageElement = document.createElement("div");
        messageElement.className = "message";
        messageElement.textContent = message;
        messageBox.appendChild(messageElement);
        messageBox.scrollTop = messageBox.scrollHeight;
      }

      function addGameLog(message, color = "white") {
        const gameLog = document.getElementById("game-log");
        const logElement = document.createElement("div");
        logElement.textContent = message;
        logElement.style.color = color;
        gameLog.appendChild(logElement);
        gameLog.scrollTop = gameLog.scrollHeight;
      }

      // æˆ¿é—´ç›¸å…³å‡½æ•°
      function joinRoom() {
        socket.emit("join_room", {
          room_id: roomId,
          name: playerName,
        });
      }

      function joinedRoom(data) {
        currentRoom = data.room;
        currentPlayerId = data.player.id;

        // æ›´æ–°ç©å®¶åˆ—è¡¨
        updateRoom(currentRoom);

        addMessage(`æ¬¢è¿æ¥åˆ°æˆ¿é—´ ${currentRoom.id}`);
      }

      function updateRoom(room) {
        // æ¸…ç©ºç©å®¶åˆ—è¡¨
        const playerList = document.getElementById("player-list");
        playerList.innerHTML = "";

        // æ·»åŠ æ‰€æœ‰ç©å®¶
        room.players.forEach((player) => {
          addPlayerToList(player, player.id === room.owner_id);
        });

        // æ›´æ–°å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼Œåªæœ‰æˆ¿ä¸»å¯è§
        const startGameBtn = document.getElementById("start-game-btn");
        if (currentPlayerId === room.owner_id) {
          startGameBtn.style.display = "inline-block";
        } else {
          startGameBtn.style.display = "none";
        }

        // æ›´æ–°å½“å‰æˆ¿é—´
        currentRoom = room;
      }

      function updatePlayersList(player, action) {
        if (action === "add") {
          // æ£€æŸ¥ç©å®¶æ˜¯å¦å·²åœ¨åˆ—è¡¨ä¸­
          const existingPlayer = document.getElementById(`player-${player.id}`);
          if (!existingPlayer) {
            addPlayerToList(player, player.id === currentRoom.owner_id);
          }
        } else if (action === "remove") {
          // ä»åˆ—è¡¨ä¸­ç§»é™¤ç©å®¶
          const playerElement = document.getElementById(`player-${player.id}`);
          if (playerElement) {
            playerElement.remove();
          }
        }
      }

      function addPlayerToList(player, isOwner) {
        const playerList = document.getElementById("player-list");
        const playerCard = document.createElement("div");
        playerCard.className = "player-card";
        playerCard.id = `player-${player.id}`;

        const ownerBadge = isOwner ? " ğŸ‘‘" : "";

        playerCard.innerHTML = `
                <div class="player-emoji">${player.emoji}</div>
                <div>${player.name}${ownerBadge}</div>
            `;

        playerList.appendChild(playerCard);
      }

      function leaveRoom() {
        if (currentRoom) {
          socket.emit("leave_room", {
            room_id: currentRoom.id,
          });
        }
      }

      function startGameRequest() {
        if (currentRoom) {
          socket.emit("start_game", {
            room_id: currentRoom.id,
          });
        }
      }

      function backToRoom() {
        if (currentRoom) {
          showScreen("room-screen");
        }
      }

      // æ¸¸æˆç›¸å…³å‡½æ•°
      function startGame(initialGameState) {
        gameState = initialGameState;
        showScreen("game-screen");

        // æ¸…ç©ºæ¸¸æˆæ—¥å¿—
        document.getElementById("game-log").innerHTML = "";
        addGameLog("æ¸¸æˆå¼€å§‹ï¼");

        // æ¸²æŸ“æ¸¸æˆ
        renderGame();
      }

      function renderGame() {
        if (!gameState) return;

        // æ›´æ–°å­å¼¹ä¿¡æ¯
        document.getElementById(
          "bullets-info"
        ).textContent = `å‰©ä½™å­å¼¹: ${gameState.remaining_bullets}`;

        // æ¸…ç©ºæ‰€æœ‰ä½ç½®
        const positions = ["top", "right", "bottom", "left"];
        positions.forEach((pos) => {
          document.getElementById(`position-${pos}`).innerHTML = "";
        });

        // æ ¹æ®ç©å®¶æ•°é‡åˆ†é…ä½ç½®
        const playerCount = gameState.players.length;
        let posIndex = 0;

        gameState.players.forEach((player) => {
          const isCurrent = player.id === gameState.current_player;
          const isDealer = player.id === gameState.dealer;

          // é€‰æ‹©ä½ç½®
          let position;
          if (player.id === currentPlayerId) {
            position = "bottom"; // å½“å‰ç©å®¶æ€»æ˜¯åœ¨åº•éƒ¨
          } else {
            if (playerCount <= 2) {
              position = "top"; // åªæœ‰ä¸€ä¸ªå¯¹æ‰‹æ—¶ï¼Œæ”¾åœ¨ä¸Šæ–¹
            } else {
              // 2ä¸ªæˆ–3ä¸ªå¯¹æ‰‹æ—¶ï¼Œåˆ†é…åˆ°ä¸Šã€å·¦ã€å³
              position = positions[posIndex];
              if (position === "bottom") posIndex++; // è·³è¿‡åº•éƒ¨ä½ç½®
              posIndex++;
            }
          }

          // åˆ›å»ºç©å®¶å…ƒç´ 
          const playerElement = document.createElement("div");
          playerElement.className = `player-card ${
            isCurrent ? "current-player" : ""
          } ${isDealer ? "dealer" : ""}`;
          playerElement.setAttribute("data-player-id", player.id);

          let healthHTML = "";
          for (let i = 0; i < 4; i++) {
            healthHTML += `<div class="health-point ${
              i < player.health ? "" : "empty"
            }"></div>`;
          }

          // é“å…·å±•ç¤º
          let itemsHTML = "";
          if (player.items.length > 0) {
            itemsHTML = '<div class="items-container">';
            player.items.forEach((item, index) => {
              // åªæœ‰å½“å‰å›åˆçš„ç©å®¶å¯ä»¥ä½¿ç”¨è‡ªå·±çš„é“å…·
              const canUse = player.id === currentPlayerId && isCurrent;
              itemsHTML += `<div class="item" ${
                canUse ? `onclick="useItem(${index})"` : ""
              }>${item}</div>`;
            });
            itemsHTML += "</div>";
          }

          playerElement.innerHTML = `
                    <div class="player-emoji">${player.emoji}</div>
                    <div>${player.name}</div>
                    <div class="player-health">${healthHTML}</div>
                    ${itemsHTML}
                `;

          // å¦‚æœæ˜¯å½“å‰å›åˆçš„å¯¹æ‰‹ï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶
          if (isCurrent && player.id !== currentPlayerId) {
            playerElement.style.cursor = "pointer";
            playerElement.addEventListener("click", () => {
              targetPlayer(player.id);
            });
          }

          // æ·»åŠ åˆ°å¯¹åº”çš„ä½ç½®
          document
            .getElementById(`position-${position}`)
            .appendChild(playerElement);
        });

        // æ›´æ–°æ˜¯å¦æ˜¯æˆ‘çš„å›åˆ
        isMyTurn = gameState.current_player === currentPlayerId;

        // æ›´æ–°æªçš„çŠ¶æ€
        const gun = document.getElementById("gun");
        gun.style.cursor = isMyTurn ? "pointer" : "default";
      }

      function useItem(itemIndex) {
        if (!isMyTurn || !currentRoom) return;

        socket.emit("use_item", {
          room_id: currentRoom.id,
          item_index: itemIndex,
        });
      }

      function useGun() {
        if (!isMyTurn || !currentRoom) return;

        const overlay = document.getElementById("target-selection-overlay");
        const targetButtons = document.getElementById("target-buttons");

        // æ¸…ç©ºæ—§æŒ‰é’®
        targetButtons.innerHTML = "";

        // åˆ›å»ºæ–°æŒ‰é’®
        gameState.players.forEach((player) => {
          if (player.id !== currentPlayerId) {
            const btn = document.createElement("button");
            btn.className = "btn";
            btn.textContent = player.name;
            btn.onclick = () => {
              targetPlayer(player.id);
              overlay.classList.add("hidden"); // é€‰æ‹©åéšè—
            };
            targetButtons.appendChild(btn);
          }
        });

        // è‡ªæ€æŒ‰é’®
        const selfBtn = document.createElement("button");
        selfBtn.className = "btn btn-secondary";
        selfBtn.textContent = "å¯¹è‡ªå·±å¼€æª";
        selfBtn.onclick = () => {
          targetPlayer(currentPlayerId);
          overlay.classList.add("hidden");
        };
        targetButtons.appendChild(selfBtn);

        // å–æ¶ˆæŒ‰é’®
        document.getElementById("cancel-selection").onclick = () => {
          overlay.classList.add("hidden");
        };

        // æ˜¾ç¤ºé€‰æ‹©æ¡†
        overlay.classList.remove("hidden");
      }

      function targetPlayer(targetId) {
        if (!isMyTurn || !currentRoom) return;

        socket.emit("pull_trigger", {
          room_id: currentRoom.id,
          target_id: targetId,
        });
      }

      function updateGame(data) {
        if (data.action === "reload") {
          const logText = `æªæ”¯å·²è£…å¡«ï¼å®å¼¹ ${data.live} å‘ | ç©ºå¼¹ ${data.blank} å‘`;
          addGameLog(logText, "red");
          return;
        }
        gameState = data.game_state;

        // æ·»åŠ ç»“æœåˆ°æ¸¸æˆæ—¥å¿—
        addGameLog(data.result);

        // é‡æ–°æ¸²æŸ“æ¸¸æˆ
        renderGame();

        // å¦‚æœæœ‰ç©å®¶æ­»äº¡ï¼Œæ˜¾ç¤ºæç¤º
        if (data.result.includes("å·²ç»æ­»äº¡")) {
          addGameLog("æœ‰ç©å®¶æ­»äº¡ï¼");
        }

        // å¦‚æœæ¸¸æˆç»“æŸï¼Œæ˜¾ç¤ºæç¤º
        if (data.result.includes("æ¸¸æˆç»“æŸ")) {
          addGameLog("æ¸¸æˆç»“æŸï¼");
        }
      }

      function endGame(data) {
        addGameLog(data.result);
        addGameLog(`æ¸¸æˆç»“æŸï¼${data.winner.name} è·èƒœï¼`);

        // 5ç§’åè¿”å›æˆ¿é—´
        setTimeout(() => {
          showScreen("room-screen");
          updateRoom(data.room);
          location.reload();
        }, 5000);
      }
    </script>
  </body>
</html>
